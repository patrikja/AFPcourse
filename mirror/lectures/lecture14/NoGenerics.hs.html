<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>lectures/lecture14/NoGenerics.hs</title>
</head>
<body>
<pre><font color=Blue>{-# LANGUAGE TypeSynonymInstances, OverlappingInstances, FlexibleContexts #-}</font>
<u><font color="#804000">import</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Applicative</font>  <font color="#808080">(</font><font color=Green>Applicative</font><font color="#808080">,</font> pure<font color="#808080">,</font> <font color="#808080">(</font><font color="#800080">&lt;*&gt;</font><font color="#808080">)</font><font color="#808080">,</font> <font color="#808080">(</font><font color="#800080">&lt;$&gt;</font><font color="#808080">)</font><font color="#808080">)</font>
<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font><font color="#800080">.</font><font color=Green>Reader</font> 
              <u><font color="#804000">as</font></u> <font color=Green>CMR</font>        <font color="#808080">(</font><font color=Green>MonadReader</font><font color="#808080">,</font> runReader<font color="#808080">,</font> ask<font color="#808080">,</font> local<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Traversable</font>     <font color="#808080">(</font><font color=Green>Traversable</font><font color="#808080">,</font> traverse<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Foldable</font>        <font color="#808080">(</font><font color=Green>Foldable</font><font color="#808080">,</font> foldMap<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Monoid</font>          <font color="#808080">(</font>mempty<font color="#808080">,</font> mappend<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Set</font> <font color="#808080">(</font><font color=Green>Set</font><font color="#808080">)</font>
<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Set</font> <u><font color="#804000">as</font></u> <font color=Green>Set</font>
<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Map</font> <font color="#808080">(</font><font color=Green>Map</font><font color="#808080">)</font>
<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Map</font> <u><font color="#804000">as</font></u> <font color=Green>Map</font>
<u><font color="#804000">import</font></u> <font color=Green>Text</font><font color="#800080">.</font><font color=Green>Printf</font> <font color="#808080">(</font>printf<font color="#808080">)</font>

<font color=Blue>-- We split our datatype into the top-level structure (Expr')</font>
<font color=Blue>-- and the recursive knot-tying (Expr)</font>
<u><font color="#804000">type</font></u> <font color=Green>Name</font> <font color="#808080">=</font> <font color=Green>String</font>
<u><font color="#804000">data</font></u> <font color=Green>Expr'</font> e <font color="#808080">=</font> <font color=Green>Var</font> <font color=Green>Name</font> <font color="#808080">|</font> <font color=Green>App</font> e e <font color="#808080">|</font> <font color=Green>Lam</font> <font color=Green>Name</font> e
<u><font color="#804000">newtype</font></u> <font color=Green>Expr</font> <font color="#808080">=</font> <font color=Green>Expr</font> <font color="#808080">{</font> unExpr <font color="#808080">::</font> <font color=Green>Expr'</font> <font color=Green>Expr</font> <font color="#808080">}</font>

<font color=Blue>-- Expr' has all kinds of nice properties it is in </font>
<font color=Blue>--   Functor, Foldable, Traversable</font>
<font color=Blue>-- For freeVars we only need Foldable (and Monoid (Set a)).</font>

<font color=Blue>-- foldMap :: (Foldable t, Monoid m) =&gt; </font>
<font color=Blue>--            (a -&gt; m) -&gt; t a -&gt; m</font>
<u><font color="#804000">instance</font></u> <font color=Green>Foldable</font> <font color=Green>Expr'</font> <u><font color="#804000">where</font></u>
  foldMap f <font color="#808080">(</font><font color=Green>Var</font> <u><font color="#804000">_</font></u><font color="#808080">)</font>     <font color="#808080">=</font> mempty
  foldMap f <font color="#808080">(</font><font color=Green>App</font> e1 e2<font color="#808080">)</font> <font color="#808080">=</font> f e1  <font color="#800080">`mappend`</font>  f e2
  foldMap f <font color="#808080">(</font><font color=Green>Lam</font> <u><font color="#804000">_</font></u> e<font color="#808080">)</font>   <font color="#808080">=</font> f e

<font color=Blue>-- Once we get the instances out of the way we can define</font>
<font color=Blue>-- @freeVars@ quite elegantly.</font>

freeVars <font color="#808080">::</font> <font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>Set</font> <font color=Green>Name</font>
freeVars <font color="#808080">(</font><font color=Green>Expr</font> e<font color="#808080">)</font> <font color="#808080">=</font> <u><font color="#804000">case</font></u> e <u><font color="#804000">of</font></u>
  <font color=Green>Var</font> x   <font color="#808080">-&gt;</font> <font color=Green>Set</font><font color="#800080">.</font>singleton x
  <font color=Green>Lam</font> x e <font color="#808080">-&gt;</font> <font color=Green>Set</font><font color="#800080">.</font>delete x <font color="#808080">(</font>freeVars e<font color="#808080">)</font>
  <u><font color="#804000">_</font></u>       <font color="#808080">-&gt;</font> foldMap freeVars e

<font color=Blue>-- Another more interesting example: alphaRename</font>

<u><font color="#804000">instance</font></u> <font color=Green>Functor</font> <font color=Green>Expr'</font> <u><font color="#804000">where</font></u>
  fmap f <font color="#808080">(</font><font color=Green>Var</font> x<font color="#808080">)</font>     <font color="#808080">=</font> <font color=Green>Var</font> x
  fmap f <font color="#808080">(</font><font color=Green>App</font> e1 e2<font color="#808080">)</font> <font color="#808080">=</font> <font color=Green>App</font>   <font color="#808080">(</font>f e1<font color="#808080">)</font> <font color="#808080">(</font>f e2<font color="#808080">)</font>
  fmap f <font color="#808080">(</font><font color=Green>Lam</font> x e<font color="#808080">)</font>   <font color="#808080">=</font> <font color=Green>Lam</font> x <font color="#808080">(</font>f e<font color="#808080">)</font>

<font color=Blue>-- traverse :: (Traversable t, Applicative f) =&gt; </font>
<font color=Blue>--             (a -&gt; f b) -&gt; t a -&gt; f (t b)</font>
<u><font color="#804000">instance</font></u> <font color=Green>Traversable</font> <font color=Green>Expr'</font> <u><font color="#804000">where</font></u>
  traverse f <font color="#808080">(</font><font color=Green>Var</font> x<font color="#808080">)</font>     <font color="#808080">=</font> pure <font color="#808080">(</font><font color=Green>Var</font> x<font color="#808080">)</font>
  traverse f <font color="#808080">(</font><font color=Green>App</font> e1 e2<font color="#808080">)</font> <font color="#808080">=</font> <font color=Green>App</font>    <font color="#800080">&lt;$&gt;</font>  f e1  <font color="#800080">&lt;*&gt;</font>  f e2
  traverse f <font color="#808080">(</font><font color=Green>Lam</font> x e<font color="#808080">)</font>   <font color="#808080">=</font> <font color=Green>Lam</font> x  <font color="#800080">&lt;$&gt;</font>  f e

<u><font color="#804000">type</font></u> <font color=Green>Supply</font> <font color="#808080">=</font> <font color="#808080">[</font><font color=Green>Name</font><font color="#808080">]</font>
names <font color="#808080">::</font> <font color=Green>Supply</font>
names <font color="#808080">=</font> <font color="#808080">[</font> s <font color="#800080">++</font> <font color="#808080">[</font>c<font color="#808080">]</font> <font color="#808080">|</font> s <font color="#808080">&lt;-</font> <font color=Magenta>""</font><b><font color="#800080">:</font></b>names<font color="#808080">,</font> c <font color="#808080">&lt;-</font> <font color="#808080">[</font><font color=Magenta>'a'</font><font color="#808080">..</font><font color=Magenta>'z'</font><font color="#808080">]</font> <font color="#808080">]</font>
<u><font color="#804000">type</font></u> <font color=Green>Renaming</font> <font color="#808080">=</font> <font color=Green>Map</font> <font color=Green>Name</font> <font color=Green>Name</font>
<u><font color="#804000">type</font></u> <font color=Green>Env</font> <font color="#808080">=</font> <font color="#808080">(</font><font color=Green>Supply</font><font color="#808080">,</font> <font color=Green>Renaming</font><font color="#808080">)</font>

alphaRename <font color="#808080">::</font> <font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>Expr</font>
alphaRename e <font color="#808080">=</font> <font color=Green>CMR</font><font color="#800080">.</font>runReader <font color="#808080">(</font>alpha e<font color="#808080">)</font> <font color="#808080">(</font>names<font color="#808080">,</font> <font color=Green>Map</font><font color="#800080">.</font>empty<font color="#808080">)</font>

<font color=Blue>-- alpha :: CMR.MonadReader Env m =&gt; Expr -&gt; m Expr    </font>
alpha <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>CMR</font><font color="#800080">.</font><font color=Green>MonadReader</font> <font color=Green>Env</font> m<font color="#808080">,</font> <font color=Green>Applicative</font> m<font color="#808080">)</font> <font color="#808080">=&gt;</font>
         <font color=Green>Expr</font> <font color="#808080">-&gt;</font> m <font color=Green>Expr</font>
alpha <font color="#808080">(</font><font color=Green>Expr</font> e<font color="#808080">)</font> <font color="#808080">=</font> <font color=Green>Expr</font> <font color="#800080">&lt;$&gt;</font> <u><font color="#804000">case</font></u> e <u><font color="#804000">of</font></u>
  <font color=Green>Var</font> x   <font color="#808080">-&gt;</font> <font color=Green>Var</font> <font color="#800080">&lt;$&gt;</font> rename x
  <font color=Green>Lam</font> x e <font color="#808080">-&gt;</font> fresh x <font color="#800080">$</font> <font color="#808080">\</font>y <font color="#808080">-&gt;</font> <font color=Green>Lam</font> y <font color="#800080">&lt;$&gt;</font> alpha e
  <u><font color="#804000">_</font></u>       <font color="#808080">-&gt;</font> traverse alpha e

rename <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>CMR</font><font color="#800080">.</font><font color=Green>MonadReader</font> <font color="#808080">(</font>s<font color="#808080">,</font> <font color=Green>Map</font> n n<font color="#808080">)</font> m<font color="#808080">,</font> <font color=Green>Ord</font> n<font color="#808080">)</font> <font color="#808080">=&gt;</font> n <font color="#808080">-&gt;</font> m n
rename x <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  <font color="#808080">(</font><b><font color=Magenta>_supply</font></b><font color="#808080">,</font> ren<font color="#808080">)</font> <font color="#808080">&lt;-</font> <font color=Green>CMR</font><font color="#800080">.</font>ask
  return <font color="#800080">$</font> maybe x id <font color="#800080">$</font> <font color=Green>Map</font><font color="#800080">.</font>lookup x ren

fresh <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>CMR</font><font color="#800080">.</font><font color=Green>MonadReader</font> <font color="#808080">(</font><font color="#808080">[</font>t<font color="#808080">]</font><font color="#808080">,</font> <font color=Green>Map</font> k t<font color="#808080">)</font> m<font color="#808080">,</font> <font color=Green>Ord</font> k<font color="#808080">)</font> <font color="#808080">=&gt;</font> 
         k <font color="#808080">-&gt;</font> <font color="#808080">(</font>t <font color="#808080">-&gt;</font> m b<font color="#808080">)</font> <font color="#808080">-&gt;</font> m b
fresh x f <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  <font color="#808080">(</font>y<b><font color="#800080">:</font></b>names<font color="#808080">,</font> ren<font color="#808080">)</font> <font color="#808080">&lt;-</font> <font color=Green>CMR</font><font color="#800080">.</font>ask
  f y   <font color="#800080">`inEnv`</font>  <font color="#808080">(</font>names<font color="#808080">,</font> <font color=Green>Map</font><font color="#800080">.</font>insert x y ren<font color="#808080">)</font> 

inEnv <font color="#808080">::</font> <font color=Green>CMR</font><font color="#800080">.</font><font color=Green>MonadReader</font> b m <font color="#808080">=&gt;</font> m a <font color="#808080">-&gt;</font> b <font color="#808080">-&gt;</font> m a
mx <font color="#800080">`inEnv`</font> env <font color="#808080">=</font> <font color=Green>CMR</font><font color="#800080">.</font>local <font color="#808080">(</font>const env<font color="#808080">)</font> mx

<font color=Blue>{-

-- This was earlier missing from the Haskell libraries. Not
-- needed with ghc 6.12 or later

instance Applicative (Reader e) where
  pure  = return
  (&lt;*&gt;) = ap
-}</font>

<font color=Blue>-- Examples</font>

lam <font color="#808080">::</font> <font color=Green>Name</font> <font color="#808080">-&gt;</font> <font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>Expr</font>
lam x e   <font color="#808080">=</font> <font color=Green>Expr</font> <font color="#808080">(</font><font color=Green>Lam</font> x e<font color="#808080">)</font>
app <font color="#808080">::</font> <font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>Expr</font>
app e1 e2 <font color="#808080">=</font> <font color=Green>Expr</font> <font color="#808080">(</font><font color=Green>App</font> e1 e2<font color="#808080">)</font>
var <font color="#808080">::</font> <font color=Green>Name</font> <font color="#808080">-&gt;</font> <font color=Green>Expr</font>
var x     <font color="#808080">=</font> <font color=Green>Expr</font> <font color="#808080">(</font><font color=Green>Var</font> x<font color="#808080">)</font>

e1<font color="#808080">,</font> e2<font color="#808080">,</font> e3 <font color="#808080">::</font> <font color=Green>Expr</font>
e1 <font color="#808080">=</font> lam <font color=Magenta>"x"</font> <font color="#800080">$</font> var <font color=Magenta>"x"</font>
e2 <font color="#808080">=</font> lam <font color=Magenta>"unused"</font> <font color="#800080">$</font> var <font color=Magenta>"C"</font>
e3 <font color="#808080">=</font> lam <font color=Magenta>"x"</font> <font color="#800080">$</font> lam <font color=Magenta>"y"</font> <font color="#800080">$</font> lam <font color=Magenta>"z"</font> <font color="#800080">$</font> 
     app <font color="#808080">(</font>var <font color=Magenta>"x"</font><font color="#808080">)</font> <font color="#808080">(</font>var <font color=Magenta>"z"</font><font color="#808080">)</font> <font color="#800080">`app`</font> 
     app <font color="#808080">(</font>var <font color=Magenta>"y"</font><font color="#808080">)</font> <font color="#808080">(</font>var <font color=Magenta>"z"</font><font color="#808080">)</font>

<u><font color="#804000">instance</font></u> <font color=Green>Show</font> <font color=Green>Expr</font> <u><font color="#804000">where</font></u>
  showsPrec p <font color="#808080">(</font><font color=Green>Expr</font> e<font color="#808080">)</font> <font color="#808080">=</font> showsPrec p e

<u><font color="#804000">instance</font></u> <font color=Green>Show</font> e <font color="#808080">=&gt;</font> <font color=Green>Show</font> <font color="#808080">(</font><font color=Green>Expr'</font> e<font color="#808080">)</font> <u><font color="#804000">where</font></u>
  showsPrec p <font color="#808080">(</font><font color=Green>Var</font> x<font color="#808080">)</font> <font color="#808080">=</font> showString x
  showsPrec p <font color="#808080">(</font><font color=Green>App</font> e1 e2<font color="#808080">)</font> <font color="#808080">=</font> showParen <font color="#808080">(</font>p<font color="#800080">&gt;</font><font color=Magenta>1</font><font color="#808080">)</font> <font color="#800080">$</font>
    showsPrec <font color=Magenta>1</font> e1 <font color="#800080">.</font> showString <font color=Magenta>" "</font> <font color="#800080">.</font> showsPrec <font color=Magenta>2</font> e2
  showsPrec p <font color="#808080">(</font><font color=Green>Lam</font> x e<font color="#808080">)</font> <font color="#808080">=</font> showParen <font color="#808080">(</font>p<font color="#800080">&gt;</font><font color=Magenta>0</font><font color="#808080">)</font> <font color="#800080">$</font>
    showString <font color="#808080">(</font><font color=Magenta>"\\"</font> <font color="#800080">++</font> x <font color="#800080">++</font> <font color=Magenta>"-&gt; "</font><font color="#808080">)</font> <font color="#800080">.</font> shows e

test <font color="#808080">::</font> <font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>IO</font> <font color=Green>()</font>
test e <font color="#808080">=</font> <u><font color="#804000">do</font></u> printf <font color=Magenta>"e=%s; free(e)=%s; Î±(e)=%s\n"</font> 
              <font color="#808080">(</font>show e<font color="#808080">)</font> 
              <font color="#808080">(</font>show <font color="#800080">$</font> <font color=Green>Set</font><font color="#800080">.</font>toList <font color="#800080">$</font> freeVars e<font color="#808080">)</font> 
              <font color="#808080">(</font>show <font color="#800080">$</font> alphaRename e<font color="#808080">)</font>
          
main <font color="#808080">::</font> <font color=Green>IO</font> <font color=Green>()</font>
main <font color="#808080">=</font> <u><font color="#804000">do</font></u> test e1
          test e2
          test e3
</pre>
</body>
</html>